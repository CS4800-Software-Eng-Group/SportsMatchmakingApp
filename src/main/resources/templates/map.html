<!doctype html>
<html>
    <head>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Stacked - Free CSS Template</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
		<link rel="stylesheet" href="css/main.css">
		
		<input type="hidden" id="playerZipCode" th:value="${player.zipCode}"/>
		<input type="hidden" id="playerAddress" th:value="${player.address}"/>
		<input type="hidden" id="playerCity" th:value="${player.city}"/>
		<input type="hidden" id="playerState" th:value="${player.state}"/>
    </head>
    <body style="height: 100%;">
        <div class="b-yellow row" style="height: 100vh">
			<div style="width:10%; height: 100%; padding-top: 5%; background-color: rgba(20, 20, 20, 150);">
				<a href="./search">
				<div class="menuItem">
				  <img src="img/search-icon.png" alt="" class="center">
				</div>
				</a>
				<a href="./profile">
				<div class="menuItem">
				  <img src="img/account-icon.png" alt="" class="center">
				</div>
				</a>
				<a href="./map">
				<div class="menuItem selected">
				  <img src="img/map-icon.png" alt="" class="center">
				</div>
				</a>
				<a href="./messages">
				<div class="menuItem">
				  <img src="img/messages-icon.png" alt="" class="center">
				</div>
				</a>
			</div>
			<div style="width:100%; height: 100%;">
				<div style="font-size: 42pt; font-weight:bold; color: white; padding: 25px;">Map</div>
				<div class="row" style="width:100%; height: 100%">
					<div id="mapContainer" style="float: left; width: 50%; padding-left: 25px;">
						<div id="map"></div>
					</div>
					<div style="margin-left: 52.5%; color: white; border-radius: 5%; width:40%; height: 80%; background-color: rgba(50, 50, 50, .75);">
						<div style="text-align: center; font-weight: bold; padding: 2.5%;">
							<div style="font-size: 32pt;">
								Map Point Title
							</div>
							<div style="margin-top: 10px; font-size: 18pt; text-align: left; font-weight: normal;">
								Map point description
							</div>
						</div>
					</div>
				</div>
			</div>
        </div>
    </body>
</html>

<script>
	var map;
	var markerLayer;
	var vectorSource;
	var markers = [];
	
	window.onload = function ()
	{
		var mapElement = document.getElementById('mapContainer');
		var display = mapElement.style.display;
		mapElement.style.display = 'none';
		mapElement.style.height = (mapElement.parentElement.offsetHeight) + "px";
		document.getElementById('map').style.height = "80%";
		mapElement.style.display = display;
		
		vectorSource = new ol.source.Vector({});
		
   		map = new ol.Map({
        target: 'map',
		controls: [
		
		],
        layers: [
			new ol.layer.Tile({
				source: new ol.source.OSM()
			}),
			new ol.layer.Vector({
				source: vectorSource
			})
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 4
        })
		});
		
		map.on('click', function(evt) {
			var features = map.forEachFeatureAtPixel(evt.pixel,
				function(feature) {
					console.log("Feature clicked: " + feature["values_"]["name"]);
				}
			);
		});
		
		var user = Cookies.get('username');
		var pass = Cookies.get('password');
		axios.get('/getPlayers')
		.then(function (response) {
			console.log("Players: " + response);
			response["data"].forEach(function(player) {
				// For each user that is not the current one
				if(player["username"] != user && player["password"] != pass)
				{
					placeIconAtAddress(player["zipCode"], player["address"], player["city"], player["state"], 'img/account-icon-black.png', player["firstName"] + " " + player["lastName"]);
				}
			});
		}).catch(function (error) {
			console.log(error);
		}).then(function () {
		 
		});
		
		var zip = document.getElementById("playerZipCode").value;
		var address = document.getElementById("playerAddress").value;
		var city = document.getElementById("playerCity").value;
		var state = document.getElementById("playerState").value;
		placeIconAtAddress(zip, address, city, state, 'img/home-icon-black.png', 'Home');
	};
	
	window.onresize = function()
	{
		setTimeout( function() { map.updateSize();}, 200);
	}

	// Get the Sidebar
	var mySidebar = document.getElementById("mySidebar");

	// Get the DIV with overlay effect
	var overlayBg = document.getElementById("myOverlay");

	// Toggle between showing and hiding the sidebar, and add overlay effect
	function w3_open() {
	  if (mySidebar.style.display === 'block') {
		mySidebar.style.display = 'none';
		overlayBg.style.display = "none";
	  } else {
		mySidebar.style.display = 'block';
		overlayBg.style.display = "block";
	  }
	}

	// Close the sidebar with the close button
	function w3_close() {
	  mySidebar.style.display = "none";
	  overlayBg.style.display = "none";
	}
	
	function placeIconAtAddress(zip, address, city, state, iconSrc, iconName)
	{
		axios.get('https://nominatim.openstreetmap.org/search?q=' + address + ',' + city + '&format=geocodejson&postalcode=' + zip + '&countrycodes=US')
		.then(function (response) {
			if(response["data"]["features"].length == 0)
			{
				// No response returned, this zip code is invalid
			}
			else
			{
				var coordinates = response["data"]["features"][0]["geometry"]["coordinates"];
				var longitude = coordinates[0];
				var latitude = coordinates[1];
				
				map.setView(new ol.View({
					center: ol.proj.fromLonLat([longitude, latitude]),
					zoom: 13
				}));
				
				var iconStyle = new ol.style.Style({
					image: new ol.style.Icon({
						src: iconSrc,
						scale: .5
					})
				});
				
				var homePoint = new ol.Feature({
					name: iconName,
					geometry: new ol.geom.Point(
						ol.proj.fromLonLat([longitude, latitude])
					),
				});
				
				homePoint.setStyle(iconStyle);
				
				vectorSource.addFeature(homePoint);
			}
		}).catch(function (error) {
			// handle error
		})
			.then(function () {
			// always executed
		});
	}
  
	function zoomInOnAddress()
	{
		var zip = document.getElementById("playerZipCode").value;
		var address = document.getElementById("playerAddress").value;
		var city = document.getElementById("playerCity").value;
		var state = document.getElementById("playerState").value;
		
		console.log("Focusing on zip code: " + zip);
		axios.get('https://nominatim.openstreetmap.org/search?q=' + address + ',' + city + '&format=geocodejson&postalcode=' + zip + '&countrycodes=US')
		.then(function (response) {
			if(response["data"]["features"].length == 0)
			{
				// No response returned, this zip code is invalid
			}
			else
			{
				var coordinates = response["data"]["features"][0]["geometry"]["coordinates"];
				var longitude = coordinates[0];
				var latitude = coordinates[1];
				
				map.setView(new ol.View({
					center: ol.proj.fromLonLat([longitude, latitude]),
					zoom: 13
				}));
				
				var iconStyle = new ol.style.Style({
					image: new ol.style.Icon({
						src: 'img/home-icon-black.png',
						scale: .5
					})
				});
				
				var homePoint = new ol.Feature({
					name: "Home",
					geometry: new ol.geom.Point(
						ol.proj.fromLonLat([longitude, latitude])
					),
				});
				
				homePoint.setStyle(iconStyle);
				
				vectorSource.addFeature(homePoint);
			}
		}).catch(function (error) {
			// handle error
		})
			.then(function () {
			// always executed
		});
	}
</script>
